<!-- Backdrop -->
<div
  *ngIf="isOpenTemplate()"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 transition-opacity"
  (click)="closeModal()">
</div>

<!-- Modal -->
<div
  *ngIf="isOpenTemplate()"
  class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div
    class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"
    (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100">
        {{ viewOnlyTemplate() ? 'Objetivos del Plan' : 'Añadir Objetivos' }}
      </h2>
      <button
        type="button"
        (click)="closeModal()"
        class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Body: 2 Columns Layout -->
    <div class="flex-1 overflow-hidden flex flex-row">
      
      <!-- LEFT COLUMN: Filters + Objectives (50%) -->
      <div class="w-1/2 flex flex-col overflow-hidden border-r border-slate-200 dark:border-slate-700">
        
        <!-- Loading state -->
        <div *ngIf="isLoading()" class="flex items-center justify-center flex-1">
          <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-slate-600 dark:text-slate-400">Cargando objetivos...</p>
          </div>
        </div>

        <!-- Content Area -->
        <div *ngIf="!isLoading()" class="flex-1 flex flex-col overflow-hidden p-6 gap-6">

          <!-- === FILTER SECTION === -->
          <div class="space-y-3">
            <!-- Back button (only on subcategories view) -->
            <div *ngIf="filterLevel() === 'subcategories'" class="mb-2">
              <button
                type="button"
                (click)="backToCategories()"
                class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded
                  bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100
                  hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                ← Volver
              </button>
            </div>

            <!-- Category Chips (Always visible on first level) -->
            <div *ngIf="filterLevel() === 'categories'">
              <div class="text-xs font-semibold uppercase tracking-widest text-slate-700 dark:text-slate-300 mb-2">
                Selecciona categoría
              </div>
              <div class="flex flex-wrap gap-2">
                <button
                  *ngFor="let cat of allCategories()"
                  type="button"
                  (click)="selectCategory(cat.id)"
                  class="px-3 py-1.5 text-sm rounded-full font-medium transition-all
                    border border-slate-300 dark:border-slate-600
                    bg-white dark:bg-slate-700
                    text-slate-900 dark:text-slate-100
                    hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20
                    cursor-pointer">
                  {{ cat.name }}
                  <span class="ml-1 text-xs opacity-60">({{ cat.objectiveCount }})</span>
                </button>
              </div>
            </div>

            <!-- Subcategory Chips (Only on second level) -->
            <div *ngIf="filterLevel() === 'subcategories' && selectedCategoryId()">
              <div class="text-xs font-semibold uppercase tracking-widest text-slate-700 dark:text-slate-300 mb-2">
                {{ getSelectedCategoryName() }} → Selecciona subcategoría
              </div>
              <div class="flex flex-wrap gap-2">
                <button
                  *ngFor="let sub of subcategoriesForSelectedCategory()"
                  type="button"
                  (click)="selectSubcategory(sub.id)"
                  [class.bg-blue-600]="selectedSubcategoryId() === sub.id"
                  [class.text-white]="selectedSubcategoryId() === sub.id"
                  [class.border-blue-600]="selectedSubcategoryId() === sub.id"
                  class="px-3 py-1.5 text-sm rounded-full font-medium transition-all
                    border border-slate-300 dark:border-slate-600
                    bg-white dark:bg-slate-700
                    text-slate-900 dark:text-slate-100
                    hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20
                    cursor-pointer">
                  {{ sub.name }}
                  <span class="ml-1 text-xs opacity-60">({{ sub.objectiveCount }})</span>
                </button>
              </div>
            </div>
          </div>

          <!-- === OBJECTIVES GRID === -->
          <div class="flex-1 flex flex-col overflow-hidden min-h-0">
            <div class="text-xs font-semibold uppercase tracking-widest text-slate-700 dark:text-slate-300 mb-2">
              Objetivos disponibles
              <span *ngIf="availableObjectives().length > 0" class="ml-1 opacity-60">({{ availableObjectives().length }})</span>
            </div>
            
            <!-- Grid de objetivos con scroll -->
            <div class="flex-1 overflow-y-auto pr-2 space-y-2">
              <button
                *ngFor="let obj of availableObjectives()"
                type="button"
                (click)="selectObjective(obj)"
                [class.ring-2]="isSelected(obj)"
                [class.ring-green-500]="isSelected(obj)"
                [class.bg-green-50]="isSelected(obj)"
                [class.dark:bg-green-900/20]="isSelected(obj)"
                class="w-full p-1.5 text-left text-xs rounded-md border-1.5 transition-all
                  border-slate-300 dark:border-slate-600
                  bg-white dark:bg-slate-700
                  text-slate-900 dark:text-slate-100
                  hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20
                  cursor-pointer group">
                <div class="font-medium text-xs">{{ obj.name }}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400 leading-tight">
                  {{ obj.objectiveCategoryName }}
                  <span *ngIf="obj.objectiveSubcategoryName" class="ml-0.5">
                    • {{ obj.objectiveSubcategoryName }}
                  </span>
                </div>
              </button>

              <!-- Empty state -->
              <div *ngIf="availableObjectives().length === 0" class="flex items-center justify-center h-16 text-slate-500 dark:text-slate-400">
                <p class="text-xs">Sin objetivos disponibles</p>
              </div>
            </div>
          </div>

        </div>

      </div>

      <!-- RIGHT COLUMN: Selected Tree (50%) -->
      <div class="w-1/2 bg-slate-50 dark:bg-slate-900/50 border-l border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col">
        
        <!-- Header -->
        <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700">
          <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100">
            Seleccionados
            <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
              {{ selectedObjectives().length }}
            </span>
          </h3>
        </div>

        <!-- Tree content with scroll -->
        <div class="flex-1 overflow-y-auto">
          <!-- Tree View -->
          <div *ngIf="selectedObjectives().length > 0" class="px-3 py-2 space-y-1">
            <div *ngFor="let category of selectedObjectivesTree()" class="space-y-0.5">
              <!-- Category Header -->
              <div class="px-2 py-1 rounded-md bg-blue-100 dark:bg-blue-900/30">
                <div class="text-xs font-semibold text-blue-900 dark:text-blue-300 truncate">
                  {{ category.name }}
                </div>
              </div>

              <!-- Subcategories -->
              <div class="space-y-0.5 ml-1.5 text-xs">
                <div *ngFor="let subcategory of category.children" class="space-y-0.5">
                  <div class="px-1.5 py-0.5 rounded text-xs font-medium text-slate-700 dark:text-slate-300 bg-slate-200 dark:bg-slate-700/50 truncate">
                    {{ subcategory.name }}
                  </div>

                  <!-- Objectives in Subcategory -->
                  <div class="space-y-0.5 ml-1.5 text-xs">
                    <div *ngFor="let item of subcategory.children" class="flex items-center justify-between gap-1 px-1.5 py-0.5 rounded hover:bg-slate-200 dark:hover:bg-slate-700/30 group transition">
                      <span class="text-xs text-slate-600 dark:text-slate-400 flex-1 truncate">
                        • {{ item.name }}
                      </span>
                      <button
                        *ngIf="!viewOnlyTemplate()"
                        type="button"
                        (click)="selectObjective(item.objective!)"
                        class="opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 text-red-500 hover:text-red-700 p-0.5 rounded hover:bg-red-50 dark:hover:bg-red-900/20">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div *ngIf="selectedObjectives().length === 0" class="flex items-center justify-center h-full text-slate-500 dark:text-slate-400">
            <p class="text-xs text-center px-3">Haz clic en los objetivos para seleccionar</p>
          </div>
        </div>

      </div>

    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between px-6 py-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
      <span class="text-sm font-medium text-slate-700 dark:text-slate-300">
        {{ selectedObjectives().length }} objetivo(s) seleccionado(s)
      </span>

      <div class="flex gap-3">
        <button
          type="button"
          (click)="closeModal()"
          class="px-4 py-2 text-sm font-medium rounded-lg border border-slate-300 dark:border-slate-600
            text-slate-900 dark:text-slate-100
            hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
          Cancelar
        </button>
        <button
          type="button"
          (click)="saveObjectives()"
          [disabled]="isSaving()"
          class="px-4 py-2 text-sm font-medium rounded-lg bg-blue-600 text-white
            hover:bg-blue-700 active:bg-blue-800
            disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors
            flex items-center gap-2">
          <span *ngIf="!isSaving()">
            {{ viewOnlyTemplate() ? 'Cerrar' : 'Guardar' }}
          </span>
          <span *ngIf="isSaving()" class="flex items-center gap-2">
            <span class="animate-spin rounded-full h-3.5 w-3.5 border-2 border-white border-t-transparent"></span>
            Guardando...
          </span>
        </button>
      </div>
    </div>

  </div>
</div>